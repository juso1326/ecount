# 修改目標6：Model 層空字串日期欄位處理

## 問題描述

**發現的問題：**
- 控制器層的空字串轉 null 處理只對**表單提交**有效
- 直接使用 Model 的 `update()` 方法會繞過控制器驗證邏輯
- 導致空字串仍然被寫入資料庫，觸發 MySQL 錯誤

**錯誤示例：**
```php
$user->update([
    'resign_date' => '',  // ❌ 直接傳入空字串會出錯
    'suspend_date' => '',
]);
```

**錯誤訊息：**
```
SQLSTATE[22007]: Invalid datetime format: 1292 Incorrect date value: '' 
for column `tenant_abc123_db`.`users`.`resign_date` at row 1
```

## 根本原因

1. **控制器層修復不完整**：只處理了 HTTP 請求路徑
2. **Model 層缺少保護**：沒有在 Model 層面處理空字串
3. **其他調用路徑**：
   - Tinker 直接操作
   - 批次更新
   - Seeder/Factory
   - API 調用
   - 後台任務

## 解決方案

### 方案 1：Model Mutator（推薦）

在每個 Model 中為日期欄位添加 mutator：

```php
// User.php
protected function resignDate(): Attribute
{
    return Attribute::make(
        set: fn ($value) => $value === '' ? null : $value,
    );
}

protected function suspendDate(): Attribute
{
    return Attribute::make(
        set: fn ($value) => $value === '' ? null : $value,
    );
}
```

**優點：**
- 在 Model 層面統一處理
- 適用於所有調用路徑
- Laravel 11 推薦做法
- 類型安全

### 方案 2：Boot 方法事件監聽

在 Model 的 boot 方法中統一處理：

```php
protected static function boot()
{
    parent::boot();
    
    static::saving(function ($model) {
        $dateFields = ['birth_date', 'hire_date', 'resign_date', 'suspend_date'];
        foreach ($dateFields as $field) {
            if ($model->$field === '') {
                $model->$field = null;
            }
        }
    });
}
```

**優點：**
- 集中處理所有日期欄位
- 程式碼簡潔
- 易於維護

### 方案 3：全域 Trait（最徹底）

建立一個 Trait 供所有 Model 使用：

```php
// app/Traits/HandlesEmptyDates.php
trait HandlesEmptyDates
{
    protected static function bootHandlesEmptyDates()
    {
        static::saving(function ($model) {
            foreach ($model->getCasts() as $field => $type) {
                if (in_array($type, ['date', 'datetime']) && $model->$field === '') {
                    $model->$field = null;
                }
            }
        });
    }
}
```

使用：
```php
class User extends Model
{
    use HandlesEmptyDates;
}
```

**優點：**
- 自動處理所有標記為 date/datetime 的欄位
- DRY 原則
- 全站統一
- 易於擴展

## 需要處理的 Models

根據之前的審查，以下 Models 有日期欄位：

1. **User** - 4個日期欄位
   - birth_date
   - hire_date
   - resign_date
   - suspend_date

2. **Project** - 2個日期欄位
   - start_date
   - end_date

3. **Receivable** - 3個日期欄位
   - receipt_date
   - due_date
   - paid_date

4. **Payable** - 4個日期欄位
   - payment_date
   - invoice_date
   - due_date
   - paid_date

5. **ReceivablePayment** - 1個日期欄位
   - payment_date

6. **PayablePayment** - 1個日期欄位
   - payment_date

7. **SalaryAdjustment** - 2個日期欄位
   - start_date
   - end_date

## 執行計畫

### Phase 1: 建立 Trait ✅
- [x] 建立 `app/Traits/HandlesEmptyDates.php`
- [x] 實作自動偵測並轉換邏輯
- [x] 添加測試

### Phase 2: 套用到所有 Models
- [ ] User Model
- [ ] Project Model
- [ ] Receivable Model
- [ ] Payable Model
- [ ] ReceivablePayment Model
- [ ] PayablePayment Model
- [ ] SalaryAdjustment Model

### Phase 3: 驗證測試
- [ ] Tinker 直接更新測試
- [ ] 表單提交測試
- [ ] 批次更新測試
- [ ] 確認所有路徑都正常

### Phase 4: 清理（可選）
- [ ] 考慮移除控制器層的空字串處理（因為 Model 層已處理）
- [ ] 或保留雙重保護以確保萬無一失

## 預期成果

完成後，以下所有方式都能正確處理空字串日期：

```php
// ✅ 表單提交
$request->validate(...);
User::create($validated);

// ✅ 直接 Model 操作
$user->update(['resign_date' => '']);

// ✅ 批次更新
User::where('position', 'Designer')->update(['suspend_date' => '']);

// ✅ Tinker 操作
$user->resign_date = '';
$user->save();
```

## 技術債務

- 控制器層的空字串處理可能變成冗餘程式碼
- 建議保留作為雙重保護機制
- 未來新增 Model 時記得添加 Trait

## 相關文件

- 修改目標5執行報告.md（控制器層修復）
- FIELD_FIX_SUMMARY.md（欄位修復總結）
- User Form Field Storage Fixes（Checkpoint）

---

**建立時間：** 2026-02-20  
**優先級：** 🔴 高（影響所有 Model 操作）  
**預估工時：** 2-3 小時



error log 不要問


系統設定日期格式套用

各設定值儲存後是否有效
